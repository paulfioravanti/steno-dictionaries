#!/bin/bash

# An SCPT file is a compiled script created with Apple's Script Editor.
# It is written in AppleScript, an automation scripting language used by Mac
# computers. SCPT files may be written manually or generated by recording
# actions.
# REF: What is an .scpt file: https://fileinfo.com/extension/scpt

# REF: https://github.com/koalaman/shellcheck/wiki/SC2031
# shopt -s lastpipe

ALL_APPLESCRIPT_FILES=$(find . -name "*.applescript")
declare SCPT_LIBRARY_DIR="$HOME/Library/Script Libraries/steno-dictionaries"
declare -r SCRIPT_LIBRARY_FILES="script-libraries/[a-z\-]+\.applescript"

main() {
  echo "$ALL_APPLESCRIPT_FILES" |
  grep --extended-regexp "$SCRIPT_LIBRARY_FILES" |
  while read -r script_library_file; do
    local scpt_library_file=$(compile_applescript_file "$script_library_file")
    cp "$scpt_library_file" "$SCPT_LIBRARY_DIR"
    rm "$scpt_library_file"
  done

  echo "$ALL_APPLESCRIPT_FILES" |
  grep --extended-regexp --invert-match "$SCRIPT_LIBRARY_FILES" |
  while read -r applescript_source_file; do
    compile_applescript_file "$applescript_source_file" > /dev/null
  done
}

compile_applescript_file() {
  local -r applescript_filename=$1
  local -r scpt_filename="$(echo "$applescript_filename" | cut -d'.' -f1,2).scpt"
  osacompile -o "$scpt_filename" "$applescript_filename"
  echo "$scpt_filename"
}

main "$@"
