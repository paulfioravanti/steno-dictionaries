#!/bin/bash

# An SCPT file is a compiled script created with Apple's Script Editor.
# It is written in AppleScript, an automation scripting language used by Mac
# computers. SCPT files may be written manually or generated by recording
# actions.
# REF: What is an .scpt file: https://fileinfo.com/extension/scpt

# REF: https://github.com/koalaman/shellcheck/wiki/SC2031
# shopt -s lastpipe

APPLESCRIPT_FILES=$(find . -name "*.applescript")
declare SCPT_LIBRARY_DIR="$HOME/Library/Script Libraries/steno-dictionaries"
declare -r LIBRARY_FILE_PATTERN="command/[a-z]+\.applescript"

main() {
  echo "$APPLESCRIPT_FILES" |
  grep --extended-regexp "$LIBRARY_FILE_PATTERN" |
  while read -r applescript_library_file; do
    local scpt_library_file=$(compile_applescript_file "$applescript_library_file")
    cp "$scpt_library_file" "$SCPT_LIBRARY_DIR"
  done

  echo "$APPLESCRIPT_FILES" |
  grep --extended-regexp --invert-match "$LIBRARY_FILE_PATTERN" |
  while read -r applescript_source_file; do
    compile_applescript_file "$applescript_source_file" > /dev/null
  done
}

compile_applescript_file() {
  local -r applescript_file=$1
  local -r scpt_filename="$(echo "$applescript_file" | cut -d'.' -f1,2).scpt"
  osacompile -o "$scpt_filename" "$applescript_file"
  echo "$scpt_filename"
}

main "$@"
